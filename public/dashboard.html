<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Media Vault Dashboard</title>
    <!-- Suppress noisy extension-originated console errors (e.g., background-redux-new.js) -->
    <script src="/js/ignore-extension-errors.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #111827;
            --surface-2: #0b1220;
            --text: #ffffff;
            --text-muted: rgba(255,255,255,0.75);
            --border: #1f2937;
            --border-light: #374151;
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --accent: #34d399;
            --accent-hover: #10b981;
            --danger: #f87171;
            --danger-hover: #ef4444;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
            --radius: 12px;
            --focus: 0 0 0 3px rgba(96,165,250,0.35);
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,0.10), rgba(0,0,0,0) 40%),
            radial-gradient(900px 600px at 110% 10%, rgba(16,185,129,0.10), rgba(0,0,0,0) 35%),
            var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            min-height: 100vh;
            padding: 2rem 1.25rem;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: clamp(1.6rem, 2.4vw, 2.25rem);
            font-weight: 800; letter-spacing: 0.2px;
            margin-bottom: 2rem;
        }
        .dashboard-controls {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)), var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem; margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .control-group label { font-weight: 600; font-size: 0.9rem; }
        .control-group input, .control-group select {
            padding: 0.75rem; border: 1px solid var(--border);
            background: var(--surface-2); color: var(--text);
            border-radius: 8px; font-size: 0.9rem;
            transition: border-color 0.2s ease, background 0.2s ease;
        }
        .control-group input:focus, .control-group select:focus {
            outline: none; box-shadow: var(--focus);
            border-color: var(--primary);
            background: color-mix(in oklab, var(--surface-2), var(--primary) 6%);
        }

        .multi-select-filters {
            background: var(--surface-2);
            border: 1px solid var(--border-light);
            border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;
        }
        .multi-select-filters h3 {
            margin: 0 0 1.5rem 0; font-size: 1.1rem; font-weight: 600; text-align: center;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem; margin-bottom: 1.5rem;
        }
        .filter-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .filter-group label { font-size: 0.9rem; font-weight: 600; }
        .multi-select-container { position: relative; display: block; }
        .multi-select-button {
            background: var(--bg); border: 1px solid var(--border); color: var(--text);
            padding: 0.75rem; border-radius: 8px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; font-size: 0.9rem; transition: border-color 0.2s ease;
        }
        .multi-select-button:hover { border-color: var(--primary); }
        .multi-select-button.active {
            border-color: var(--primary);
            background: color-mix(in oklab, var(--bg), var(--primary) 8%);
        }
        .multi-select-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 8px; box-shadow: var(--shadow); z-index: 1000;
            max-height: 300px; display: none; margin-top: 2px;
        }
        .multi-select-dropdown.open { display: block; }
        .multi-select-search {
            position: sticky; top: 0; background: var(--surface-2);
            padding: 0.75rem; border-bottom: 1px solid var(--border-light);
        }
        .multi-select-search input {
            width: 100%; padding: 0.5rem; border: 1px solid var(--border);
            background: var(--bg); color: var(--text); border-radius: 6px; font-size: 0.85rem;
        }
        .multi-select-search input:focus { outline: none; box-shadow: var(--focus); border-color: var(--primary); }
        .multi-select-options { max-height: 200px; overflow-y: auto; }
        .multi-select-option {
            padding: 0.6rem 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.85rem; border-bottom: 1px solid var(--border-light); transition: background 0.2s ease;
        }
        .multi-select-option:last-child { border-bottom: none; }
        .multi-select-option:hover { background: var(--surface-2); }
        .multi-select-option.hidden { display: none; }
        .multi-select-option input[type="checkbox"] { margin: 0; accent-color: var(--primary); }
        .no-results { padding: 1rem; text-align: center; color: var(--text-muted); font-style: italic; font-size: 0.85rem; }

        .active-filters-section { margin-bottom: 1.5rem; }
        .active-filters-title { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.75rem; font-weight: 500; }
        .active-filters { display: flex; flex-wrap: wrap; gap: 0.5rem; min-height: 32px; }
        .filter-chip {
            background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 999px;
            font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;
        }
        .filter-chip-category { opacity: 0.8; font-size: 0.7rem; }
        .filter-chip .remove-chip {
            background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%;
            width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 14px; line-height: 1; transition: background 0.2s ease;
        }
        .filter-chip .remove-chip:hover { background: rgba(255,255,255,0.3); }

        .selection-controls {
            background: var(--surface-2); border: 1px solid var(--border-light);
            border-radius: 8px; padding: 1rem; margin-bottom: 2rem;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;
        }
        .selection-info { display: flex; align-items: center; gap: 1rem; font-size: 0.9rem; color: var(--text-muted); }
        .selection-count {
            background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 600;
        }
        .selection-actions { display: flex; align-items: center; gap: 0.5rem; }
        .btn {
            background: var(--primary); color: white; border: none; padding: 0.5rem 1rem;
            border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: background 0.2s ease;
        }
        .btn:hover { background: var(--primary-hover); }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: var(--danger-hover); }
        .btn-accent { background: var(--accent); }
        .btn-accent:hover { background: var(--accent-hover); }

        .stats-bar {
            background: var(--surface-2); padding: 1rem; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;
        }
        .stat-item { text-align: center; }
        .stat-number { display: block; font-size: 1.5rem; font-weight: 800; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: var(--text-muted); }

        .media-table-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)), var(--surface);
            border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow);
        }
        .table-wrapper { overflow: auto; max-height: 70vh; position: relative; border-radius: var(--radius); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th {
            background: var(--surface-2); padding: 1rem 0.75rem; text-align: left; font-weight: 700;
            border-bottom: 2px solid var(--border); border-right: 2px solid var(--border-light);
            font-size: 0.85rem; position: sticky; top: 0; z-index: 10;
        }
        th:last-child { border-right: none; }
        td {
            padding: 0.75rem; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border-light);
            font-size: 0.85rem; vertical-align: top;
        }
        td:last-child { border-right: none; }
        tbody tr:hover { background: color-mix(in oklab, var(--surface), var(--primary) 4%); }
        tbody tr.selected { background: color-mix(in oklab, var(--surface), var(--primary) 12%); }
        .row-select { accent-color: var(--primary); transform: scale(1.1); }

        .pagination { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--surface-2); border-top: 1px solid var(--border); }
        .pagination-controls { display: flex; align-items: center; gap: 0.75rem; }
        .pagination-controls button { min-width: 100px; }

        .loading { text-align: center; padding: 2rem; color: var(--text-muted); }
        .error {
            background: #7f1d1d; border: 1px solid var(--danger); color: var(--text);
            padding: 1rem; border-radius: 8px; margin: 1rem;
        }

        .column-badge {
            background: var(--surface-2);
            border: 1px dashed var(--border-light);
            color: var(--text-muted);
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .media-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            align-items: start;
        }
        .details-panel {
            position: fixed;
            top: 2rem;
            right: 1.25rem;
            width: min(840px, 50vw);
            max-height: calc(100vh - 4rem);
            z-index: 2000;

            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)), var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: auto;
            padding: 1rem;

            transform: translateX(100%);
            opacity: 0;
            transition: transform 240ms ease, opacity 240ms ease;
        }
        .details-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        @media (max-width: 900px) {
            .details-panel {
                left: 1.25rem;
                right: 1.25rem;
                width: auto;
            }
        }
        .details-header {
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: var(--surface); padding-bottom: .5rem; margin-bottom: .5rem;
            border-bottom: 1px solid var(--border);
        }
        .pill {
            display: inline-block; padding: .2rem .5rem; border-radius: 999px; background: var(--surface-2); border: 1px solid var(--border-light); font-size: .75rem;
        }
        .feature-pill {
            display: inline-block; padding: .2rem .5rem; margin: 2px; border-radius: 999px; background: color-mix(in oklab, var(--primary), black 70%); font-size: .75rem;
        }
        .media-grid {
            display: grid; grid-template-columns: 1fr; gap: .75rem;
        }
        .thumb-grid {
            display: grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap: .5rem;
        }
        .thumb {
            background: var(--surface-2); border: 1px solid var(--border-light); border-radius: 8px; overflow: hidden;
        }
        .thumb img { display: block; width: 100%; height: auto; }
        .kv { display: grid; grid-template-columns: 140px 1fr; gap: .5rem .75rem; font-size: .85rem; }
        .kv div.key { color: var(--text-muted); }
        .section-title { font-weight: 700; margin-top: .5rem; margin-bottom: .25rem; }
        .link {
            color: var(--primary);
            text-decoration: none;
        }
        .link:hover { text-decoration: underline; }
        .clickable-cell { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; }

        .badge {
            display: inline-block;
            padding: .16rem .5rem;
            border-radius: 999px;
            border: 1px solid var(--border-light);
            font-size: .75rem;
            line-height: 1.2;
        }
        .badge-success { background: rgba(16,185,129,0.12); border-color: rgba(52,211,153,0.5); }
        .badge-danger { background: rgba(239,68,68,0.12); border-color: rgba(248,113,113,0.5); }
        .badge-warning { background: rgba(245,158,11,0.12); border-color: rgba(251,191,36,0.5); }
        .badge-info { background: rgba(59,130,246,0.12); border-color: rgba(96,165,250,0.5); }
        .badge-neutral { background: var(--surface-2); border-color: var(--border-light); }
        .date-pill { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; opacity: 0.9; }
        .country-pill { margin: 2px; }
        .category-pill { background: color-mix(in oklab, var(--primary), black 75%); border-color: rgba(96,165,250,0.4); }

        @media (max-width: 768px) {
            .controls-grid, .filters-grid { grid-template-columns: 1fr; }
            .stats-bar { flex-direction: column; gap: 1rem; }
            .pagination { flex-direction: column; gap: 1rem; }
            .pagination-controls { flex-direction: column; width: 100%; }
            .pagination-controls button { width: 100%; }
            .selection-controls { flex-direction: column; align-items: stretch; }
            .media-layout { grid-template-columns: 1fr; }
            .details-panel { order: 2; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>🎬 Media Vault Dashboard</h1>

    <div class="dashboard-controls">
        <div class="controls-grid">
            <div class="control-group">
                <label for="search">🔍 Search</label>
                <input type="text" id="search" placeholder="Search titles or series..."/>
            </div>
            <div class="control-group">
                <label for="per-page">📄 Items per Page</label>
                <select id="per-page">
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                    <option value="ALL">ALL</option>
                </select>
            </div>
        </div>

        <div class="multi-select-filters">
            <h3>🎯 Advanced Filters</h3>

            <div class="active-filters-section">
                <div class="active-filters-title">Active Filters:</div>
                <div class="active-filters" id="active-filters">
                    <span style="color: var(--text-muted); font-style: italic;">No filters applied</span>
                </div>
            </div>

            <div class="filters-grid">
                <div class="filter-group">
                    <label>📺 Series</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="series">
                            <span>Select series...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>🎭 Content Type</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="contentType">
                            <span>Select types...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>📡 Availability</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="availability">
                            <span>Select availability...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>⭐ Features</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="features">
                            <span>Select features...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>📦 CMAF</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="cmaf">
                            <span>Select CMAF status...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>🔢 Season</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="season">
                            <span>Select seasons...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>🎬 Episode</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="episode">
                            <span>Select episodes...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                </div>

                <div class="filter-group">
                    <label>🧱 Columns</label>
                    <div class="multi-select-container">
                        <button class="multi-select-button" data-filter="columns">
                            <span>Select columns...</span><span>▼</span>
                        </button>
                        <div class="multi-select-dropdown"></div>
                    </div>
                    <div id="columns-selected-hint" class="column-badge" style="margin-top:8px;"></div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="btn btn-danger" id="clear-all-filters">🗑️ Clear All Filters</button>
            </div>
        </div>
    </div>

    <div class="selection-controls">
        <div class="selection-info">
            <span>📋 Selection:</span>
            <span class="selection-count" id="selection-count">0 selected</span>
        </div>
        <div class="selection-actions">
            <button class="btn" id="select-all-visible-btn">✅ Select Page</button>
            <button class="btn" id="select-all-btn">✅ Select All Filtered</button>
            <button class="btn btn-danger" id="clear-selection-btn">❌ Clear Selection</button>
            <button class="btn btn-accent" id="export-csv-btn">📊 Export to CSV</button>
        </div>
    </div>

    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-number" id="total-items">0</span>
            <span class="stat-label">Total Items</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="filtered-items">0</span>
            <span class="stat-label">Filtered Results</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="total-series">0</span>
            <span class="stat-label">Series</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="cmaf-count">0</span>
            <span class="stat-label">CMAF Enabled</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="encoded-count">0</span>
            <span class="stat-label">Encoded</span>
        </div>
    </div>

    <div class="media-layout" id="media-layout" style="display:none;">
        <div id="left-col">
            <div class="media-table-container">
                <div class="loading" id="loading">Loading media data...</div>
                <div class="error" id="error" style="display:none;"></div>

                <div class="table-wrapper" style="display:none;" id="table-wrapper">
                    <table id="media-table">
                        <thead>
                        <tr id="table-head-row">
                            <th style="width:50px;">
                                <input type="checkbox" id="select-all-checkbox" class="row-select" aria-label="Select all rows"/>
                            </th>
                            <!-- dynamic headers -->
                        </tr>
                        </thead>
                        <tbody id="media-tbody"></tbody>
                    </table>
                </div>

                <div class="pagination" id="pagination" style="display:none;">
                    <div>
                        <div id="pagination-main">Page 1 of 1</div>
                        <div id="pagination-details" style="color:var(--text-muted); font-size:0.85rem;">Showing 0 to 0 of 0 entries</div>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn" id="prev-btn">« Previous</button>
                        <button class="btn" id="next-btn">Next »</button>
                    </div>
                </div>
            </div>
        </div>
        <aside class="details-panel" id="details-panel" aria-live="polite">
            <div class="details-header">
                <div style="font-weight:700;">Media Details</div>
                <button class="btn btn-danger" id="close-details-btn">Close</button>
            </div>
            <div id="details-content" style="color: var(--text-muted);">Select a media item to view details.</div>
        </aside>
    </div>
</div>

<script type="module">
    // Config and state
    let API_BASE = '';
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    let allData = [];
    let filteredData = [];
    let displayedData = [];
    let allStats = {};
    const selectedRows = new Set();
    let lastSelectedIndex = null;

    // ALL selectable columns (flat and nested dot/bracket paths)
    const ALL_COLUMNS = [
        // Virtual/derived columns first
        'CMAF Status',
        // Schema columns
        'guid','title','cbs$SeriesTitle','id','added','updated','approved','description','availableDate','ratings',
        'cbs$EpisodeNumber','cbs$PrimaryCategoryName','cbs$SourcePartner','cbs$videoProperties','pubDate','provider',
        'cbs$EpisodeFlag','cbs$PrimaryCategory','cbs$VideoID','ytcp$youTubeVideoIds','cbs$TMSSeriesID','cbs$SeasonNumber',
        'cbs$premiumFeatures','cbs$contentType','excludeCountries','expirationDate','availabilityState','countries',
        'cbs$ClosedCaptionURL','cbs$Omit','cbs$ProductionNumber','cbs$TMSProgramID','cbs$VTAG',
        // Note: content[] and thumbnails[] are intentionally NOT offered in columns selector (kept nested only)
        'cbs$Aired','cbs$Archive','cbs$CBSGenre','cbs$CategoryURL','cbs$DVRData','cbs$DynamicStreaming','cbs$Embeddable',
        'cbs$EpisodeTitle','cbs$Episodic','cbs$Internal','cbs$IsClosedCaption','cbs$IsLive','cbs$IsLiveCDN',
        'cbs$IsMigratedFromMPS','cbs$IsProtected','cbs$Label','cbs$Location','cbs$NoAd','cbs$PublishToYahoo','cbs$RepeatFlag',
        'cbs$SIDseason','cbs$SIDseries','cbs$SIDtitle','cbs$SiteShowID','cbs$SourcePartnerLogoURL','cbs$SourceThumbnailLastUpdated',
        'cbs$SourceType','cbs$SourceVideoLastUpdated','cbs$SubHeadline','cbs$TVRating','cbs$WatermarkPlayback','cbs$YouTubeLabel',
        'cbs$YouTubeReferencePolicy','cbs$allAccessDownloadAvailability','cbs$artist','cbs$childContentId','cbs$clipEnd',
        'cbs$clipStart','cbs$cropValue','cbs$dARCode','cbs$dARName','cbs$dPRAired','cbs$dataURL','cbs$director',
        'cbs$dontPublishToMSN','cbs$dontPublishToYoutube','cbs$drmPolicyId','cbs$drmPolicyName','cbs$eNTDARName',
        'cbs$excludeNielsenTracking','cbs$excludeOzTam','cbs$forensicWatermark','cbs$genre','cbs$gracenoteVodMatch',
        'cbs$hdrEncodingMode','cbs$ingestMethod','cbs$ingestedChapters','cbs$ingestedSidecars','cbs$isFeatured','cbs$itunescategory',
        'cbs$itunesexplicit','cbs$localizedBrand','cbs$localizedBrandLocalized','cbs$localizedCast','cbs$localizedCastLocalized',
        'cbs$localizedLabel','cbs$localizedLabelLocalized','cbs$localizedSeriesTitle','cbs$localizedSeriesTitleLocalized',
        'cbs$localizedShortDescription','cbs$localizedShortDescriptionLocalized','cbs$originalLanguage',
        'cbs$paramountPlusFreeAvailableDate','cbs$paramountPlusFreeExpirationDate','cbs$playbackEvents','cbs$producer',
        'cbs$productPlacement','cbs$shortDescription','cbs$sizzleID','cbs$sizzleIDLocalized','cbs$sourceLanguage','cbs$stSeries',
        'cbs$subRegionTargeting','cbs$svodFreeAvailableDate','cbs$svodFreeExpirationDate','cbs$trackName','cbs$uSAvailableDate',
        'cbs$uSExpirationDate','cbs$useSourcePartnerPlayerLogo','cbs$vTTCaptions','cbs$videoRobotEncoding','cbs$youTubeCategory',
        'cbs$youTubeDescription','cbs-workflow$resetUnicornPublish','msn$msnSource','pl2$approved','pl2$isUpdated',
        'yt$video.status.privacyStatus','ytcp$youTubeAllowCommentRatings','ytcp$youTubeAllowComments','ytcp$youTubeAllowEmbedding',
        'ytcp$youTubeAllowRatings','ytcp$youTubeAllowResponses','ytcp$youTubeAssetType','ytcp$youTubeBlockOutsideOwnership',
        'ytcp$youTubeChannel','ytcp$youTubeClaimType','ytcp$youTubeCombinedDescription','ytcp$youTubeInStreamStandard',
        'ytcp$youTubeInStreamTrueView','ytcp$youTubeInVideo','ytcp$youTubeMidRolls','ytcp$youTubeNotifySubscribers',
        'ytcp$youTubePostRolls','ytcp$youTubePreRolls','ytcp$youTubePublic','ytcp$youTubePublicListed',
        'ytcp$youTubeSavedUsageRights','ytcp$youTubeSavedUsageRights2','ytcp$youTubeVideoGenre'
    ];

    // Map schema keys to API item paths
    const COLUMN_MAP = {
        'title': 'title',
        'guid': 'guid',
        'updated': 'updated_timestamp',
        'id': 'external_id',
        'cbs$SeriesTitle': 'series_title',
        'cbs$SeasonNumber': 'season_number',
        'cbs$EpisodeNumber': 'episode_number',
        'cbs$contentType': 'content_type',
        'availabilityState': 'availability_state',
        'cbs$premiumFeatures': 'premium_features',
        'countries': 'countries'
    };

    // Initial visible columns
    const visibleColumns = new Set([
        'title',
        'cbs$SeasonNumber',
        'cbs$EpisodeNumber',
        'cbs$contentType',
        'availabilityState',
        'CMAF Status',
        'cbs$premiumFeatures',
        'updated',
        'guid'
    ]);

    // Filters state
    const activeFilters = {
        series: new Set(),
        contentType: new Set(),
        availability: new Set(),
        features: new Set(),
        cmaf: new Set(),
        season: new Set(),
        episode: new Set()
    };

    // DOM refs
    const el = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        tableWrapper: document.getElementById('table-wrapper'),
        mediaTbody: document.getElementById('media-tbody'),
        pagination: document.getElementById('pagination'),
        search: document.getElementById('search'),
        perPage: document.getElementById('per-page'),
        prevBtn: document.getElementById('prev-btn'),
        nextBtn: document.getElementById('next-btn'),
        paginationMain: document.getElementById('pagination-main'),
        paginationDetails: document.getElementById('pagination-details'),
        totalItemsSpan: document.getElementById('total-items'),
        filteredItems: document.getElementById('filtered-items'),
        totalSeries: document.getElementById('total-series'),
        cmafCount: document.getElementById('cmaf-count'),
        encodedCount: document.getElementById('encoded-count'),
        activeFilters: document.getElementById('active-filters'),
        clearAllFilters: document.getElementById('clear-all-filters'),
        selectAllCheckbox: document.getElementById('select-all-checkbox'),
        selectionCount: document.getElementById('selection-count'),
        selectAllVisibleBtn: document.getElementById('select-all-visible-btn'),
        selectAllBtn: document.getElementById('select-all-btn'),
        clearSelectionBtn: document.getElementById('clear-selection-btn'),
        exportCsvBtn: document.getElementById('export-csv-btn'),
        tableHeadRow: document.getElementById('table-head-row'),
        columnsHint: document.getElementById('columns-selected-hint'),
        mediaLayout: document.getElementById('media-layout'),
        detailsContent: document.getElementById('details-content'),
        closeDetailsBtn: document.getElementById('close-details-btn')
    };

    // Global function for copy button
    window.copyToClipboard = function(text, btn) {
        if (!navigator.clipboard) {
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } finally { document.body.removeChild(ta); }
            if (btn) { const prev = btn.textContent; btn.textContent = '✅'; setTimeout(()=> btn.textContent = prev, 1200); }
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            if (btn) { const prev = btn.textContent; btn.textContent = '✅'; setTimeout(()=> btn.textContent = prev, 1200); }
        }).catch(() => {
            if (btn) { const prev = btn.textContent; btn.textContent = '⚠️'; setTimeout(()=> btn.textContent = prev, 1200); }
        });
    };

    // Helpers
    function getRowId(item) {
        return item.external_id || item.id || item.guid || `row_${item.title || ''}_${item.series_title || ''}_${Math.random().toString(36).slice(2)}`;
    }
    function escapeCSV(str) {
        if (str === null || str === undefined) return '';
        const s = String(str);
        if (s.includes('"') || s.includes(',') || s.includes('\n')) return `"${s.replace(/"/g, '""')}"`;
        return s;
    }
    function escapeHTML(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function escapeAttr(s) {
        return String(s).replace(/"/g,'&quot;');
    }
    function getByPath(obj, path) {
        const mapped = COLUMN_MAP[path] || path;
        const p = mapped.replace(/\[(\d+)\]/g, '.$1');
        return p.split('.').reduce((o, k) => (o == null ? undefined : o[k]), obj);
    }
    function isTimestampKey(key, val) {
        const k = key.toLowerCase();
        return (k.includes('date') || k.includes('time') || k.includes('updated') || k.includes('added') || k.includes('expiration')) && /^\d+$/.test(String(val));
    }
    function isDateLikeKey(key) {
        const k = String(key).toLowerCase();
        return k.includes('date') || k.includes('time') || k.includes('updated') || k.includes('added') || k.includes('expiration');
    }
    function normalizeDateValue(key, val) {
        if (val == null || val === '') return '';
        if (/^\d+$/.test(String(val))) {
            const n = Number(val);
            if (!Number.isNaN(n) && n > 0) {
                try { return new Date(n).toISOString(); } catch { /* ignore */ }
            }
        }
        const d = new Date(val);
        if (!isNaN(d.getTime())) {
            try { return d.toISOString(); } catch { /* ignore */ }
        }
        return String(val);
    }
    function sanitizeCellDisplay(s) {
        const str = String(s || '').trim();
        if (!str) return '<span class="pill">-</span>';
        return escapeHTML(str);
    }
    function renderGUIDWithLink(guid) {
        if (!guid || guid === 'N/A') {
            const safe = escapeHTML(String(guid || '')) || '<span class="pill">-</span>';
            return `<span class="guid-text">${safe}</span>`;
        }
        const deeplink = `https://videorobot-ent.paramountplus.com/jobs/show_jobs?limit=25&offset=0&order_by=desc&sort_by=id&bu=all&show_qc=true&ref_id=${encodeURIComponent(guid)}`;
        const displayGuid = String(guid).length > 18 ? String(guid).substring(0, 15) + '...' : String(guid);
        const title = `Open in Video Robot (${guid})`;
        return `
            <div class="guid-container" style="display:flex;align-items:center;gap:.4rem;">
                <a href="${deeplink}" target="_blank" rel="noopener" class="guid-link link" title="${escapeAttr(title)}">
                    ${escapeHTML(displayGuid)}
                </a>
                <button class="copy-guid-btn" onclick="copyToClipboard('${escapeAttr(String(guid))}', this)" title="Copy GUID" style="border:none;background:transparent;cursor:pointer;">
                    📋
                </button>
            </div>
        `;
    }
    function getCMAFStatus(item) {
        const features = normalizeAndSortFeatures(item.premium_features || []);
        return features.some(f => (f||'').toLowerCase().includes('cmaf') || (f||'').toLowerCase().includes('dash') || (f||'').toLowerCase().includes('hls')) ? 'Enabled' : 'Disabled';
    }

    function normalizeAndSortFeatures(arr) {
        if (!Array.isArray(arr)) return [];
        const cleaned = arr
            .flatMap(v => {
                if (v == null) return [];
                let s = String(v).trim();
                if (s.startsWith('[') && s.endsWith(']')) s = s.slice(1, -1);
                s = s.replace(/"\s+"/g, '","');
                if (s.includes(',')) return s.split(',').map(x => x.trim()).filter(Boolean);
                return [s];
            })
            .map(s => s.replace(/^"+|"+$/g,'').replace(/^'+|'+$/g,'').trim())
            .filter(Boolean);
        const seen = new Map();
        for (const f of cleaned) {
            const key = f.toLowerCase();
            if (!seen.has(key)) seen.set(key, f);
        }
        const uniq = Array.from(seen.values());
        return uniq.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
    }

    function nestArrays(row) {
        const media = { ...row };
        const content = [];
        const thumbnails = [];
        Object.keys(media).forEach(k => {
            let m = k.match(/^content\[(\d+)]\.(.+)$/);
            if (m) {
                const idx = Number(m[1]);
                content[idx] = content[idx] || {};
                content[idx][m[2]] = media[k];
                delete media[k];
                return;
            }
            m = k.match(/^thumbnails\[(\d+)]\.(.+)$/);
            if (m) {
                const idx = Number(m[1]);
                thumbnails[idx] = thumbnails[idx] || {};
                thumbnails[idx][m[2]] = media[k];
                delete media[k];
            }
        });
        if (content.length) media.content = content;
        if (thumbnails.length) media.thumbnails = thumbnails;

        if (media.premium_features) {
            media.premium_features = normalizeAndSortFeatures(media.premium_features);
        }

        return media;
    }

    // Config
    async function loadConfig() {
        // Since dashboard.html is not processed by Vite, we can't use import.meta.env
        // Use hardcoded values or try to detect from window.location

        try {
            // Try to get config from backend first
            const r = await fetch('/api/config');
            if (r.ok) {
                const j = await r.json();
                if (j.success) {
                    API_BASE = j.config.API_BASE;
                    return;
                }
            }
        } catch {
            // Ignore and use fallback
        }

        // Fallback configuration
        const baseUrl = window.location.origin.includes('localhost:5173')
            ? 'http://localhost:3001'  // Development
            : window.location.origin;  // Production

        API_BASE = baseUrl.replace(/\/$/, '') + '/api';
    }

    async function loadFilters() {
        try {
            const r = await fetch(`${API_BASE}/stats`);
            const j = await r.json();
            if (j.success) {
                allStats = j.data;
                document.getElementById('total-items').textContent = j.data.totalItems.toLocaleString();
                document.getElementById('total-series').textContent = j.data.totalSeries.toLocaleString();
            }
        } catch {}
    }

    function buildQueryParams() {
        const p = new URLSearchParams();
        const s = el.search.value.trim();
        if (s) p.append('search', s);
        p.append('sortBy', 'title');
        p.append('sortOrder', 'ASC');
        return p;
    }

    async function loadData() {
        el.loading.style.display = 'block';
        el.error.style.display = 'none';
        el.tableWrapper.style.display = 'none';
        el.pagination.style.display = 'none';

        try {
            const params = buildQueryParams();
            const r = await fetch(`${API_BASE}/items?${params}`);
            const j = await r.json();
            if (!j.success) throw new Error(j.error || 'Failed to load');
            allData = (j.data || []).map(nestArrays);
            totalItems = j.totalItems || allData.length;

            applyFiltersAndPagination();
            el.loading.style.display = 'none';
            el.tableWrapper.style.display = 'block';
            el.pagination.style.display = 'flex';
            el.mediaLayout.style.display = 'grid';
        } catch (e) {
            el.loading.style.display = 'none';
            el.error.style.display = 'block';
            el.error.textContent = 'Error loading data: ' + e.message;
        }
    }

    function applyFiltersAndPagination() {
        filteredData = applyFilters(allData);

        const per = el.perPage.value;
        if (per === 'ALL') {
            displayedData = [...filteredData];
            totalPages = 1; currentPage = 1;
        } else {
            const n = parseInt(per, 10);
            totalPages = Math.max(1, Math.ceil(filteredData.length / n));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const start = (currentPage - 1) * n;
            displayedData = filteredData.slice(start, start + n);
        }

        renderTableHeader();
        renderTableBody(displayedData);
        updatePagination();
        updateStats(filteredData);
        updateSelectionUI();
    }

    function applyFilters(data) {
        return data.filter(item => {
            if (activeFilters.series.size && !activeFilters.series.has(String(item.series_title || ''))) return false;
            if (activeFilters.contentType.size && !activeFilters.contentType.has(String(item.content_type || ''))) return false;
            if (activeFilters.availability.size && !activeFilters.availability.has(String(item.availability_state || ''))) return false;
            if (activeFilters.features.size) {
                const feats = normalizeAndSortFeatures(item.premium_features || []);
                const hit = feats.some(f => activeFilters.features.has(String(f)));
                if (!hit) return false;
            }
            if (activeFilters.cmaf.size) {
                const status = getCMAFStatus(item);
                if (!activeFilters.cmaf.has(status)) return false;
            }
            if (activeFilters.season.size && !activeFilters.season.has(String(item.season_number || ''))) return false;
            if (activeFilters.episode.size && !activeFilters.episode.has(String(item.episode_number || ''))) return false;

            const q = el.search.value.trim().toLowerCase();
            if (q) {
                const hay = `${item.title || ''} ${item.series_title || ''}`.toLowerCase();
                if (!hay.includes(q)) return false;
            }
            return true;
        });
    }

    function updatePagination() {
        const per = el.perPage.value;
        if (per === 'ALL') {
            el.paginationMain.textContent = 'Showing All Results';
            el.paginationDetails.textContent = `Displaying all ${filteredData.length.toLocaleString()} filtered entries (${totalItems.toLocaleString()} total)`;
            el.prevBtn.disabled = true; el.nextBtn.disabled = true;
        } else {
            const n = parseInt(per, 10);
            const start = (currentPage - 1) * n + 1;
            const end = Math.min(currentPage * n, filteredData.length);
            el.paginationMain.textContent = `Page ${currentPage} of ${totalPages}`;
            el.paginationDetails.textContent = `Showing ${start.toLocaleString()} to ${end.toLocaleString()} of ${filteredData.length.toLocaleString()} entries`;
            el.prevBtn.disabled = currentPage <= 1;
            el.nextBtn.disabled = currentPage >= totalPages;
        }
    }

    function updateStats(fd) {
        document.getElementById('filtered-items').textContent = fd.length.toLocaleString();
        const cmafEnabled = fd.filter(item => getCMAFStatus(item) === 'Enabled').length;
        document.getElementById('cmaf-count').textContent = cmafEnabled.toLocaleString();

        if (allStats.premiumFeatures) {
            const encoded = allStats.premiumFeatures.find(f => (f.feature || '').toLowerCase().includes('encode'));
            document.getElementById('encoded-count').textContent = encoded ? encoded.count.toLocaleString() : '0';
        }
    }

    function renderTableHeader() {
        while (el.tableHeadRow.children.length > 1) el.tableHeadRow.removeChild(el.tableHeadRow.lastChild);
        Array.from(visibleColumns).forEach(col => {
            const th = document.createElement('th');
            th.textContent = col;
            el.tableHeadRow.appendChild(th);
        });
        updateColumnsHint();
    }

    function updateColumnsHint() {
        const maxShow = 4;
        const cols = Array.from(visibleColumns);
        const shown = cols.slice(0, maxShow).join(', ');
        const more = cols.length > maxShow ? ` +${cols.length - maxShow} more` : '';
        el.columnsHint.textContent = cols.length ? `Columns: ${shown}${more}` : 'No columns selected';
    }

    function renderTableBody(data) {
        el.mediaTbody.innerHTML = data.map(item => {
            const id = getRowId(item);
            const tds = Array.from(visibleColumns).map(col => {
                if (col === 'CMAF Status') {
                    const status = getCMAFStatus(item);
                    const pill = `<span class="pill" style="border-color:${status==='Enabled' ? 'rgba(52,211,153,0.5)' : 'rgba(248,113,113,0.5)'}; background:${status==='Enabled' ? 'rgba(16,185,129,0.1)' : 'rgba(239,68,68,0.1)'};">${status}</span>`;
                    return `<td title="Current CMAF status">${pill}</td>`;
                }
                if (col === 'title') {
                    const v = (item.title || '').toString();
                    const display = sanitizeCellDisplay(v);
                    return `<td class="clickable-cell" data-col="title" title="Click to view details in panel">${display}</td>`;
                }
                if (col === 'cbs$premiumFeatures' || col === 'premium_features') {
                    const feats = normalizeAndSortFeatures(item.premium_features || []);
                    const pills = feats.map(v => `<span class=\"feature-pill\" title=\"${escapeAttr(String(v))}\">${escapeHTML(String(v))}</span>`).join(' ');
                    return `<td class=\"clickable-cell\" data-col=\"premium_features\" title=\"Click to view details in panel\">${pills || '<span class=\"pill\">None</span>'}</td>`;
                }
                if (col === 'availabilityState' || col === 'availability_state') {
                    const raw = (item.availability_state || getByPath(item, col) || '').toString();
                    const low = raw.toLowerCase();
                    let cls = 'badge-neutral';
                    if (low.includes('available')) cls = 'badge-success';
                    else if (low.includes('expired') || low.includes('unavailable')) cls = 'badge-danger';
                    else if (low.includes('coming') || low.includes('soon') || low.includes('pending')) cls = 'badge-warning';
                    else if (low) cls = 'badge-info';
                    const label = raw || '-';
                    return `<td title="${escapeAttr(label)}"><span class="badge ${cls}">${escapeHTML(label)}</span></td>`;
                }
                if (col === 'cbs$contentType' || col === 'content_type') {
                    const v = (getByPath(item, col) || '').toString();
                    return `<td title="${escapeAttr(v)}"><span class="badge badge-info category-pill">${escapeHTML(v || '-')}</span></td>`;
                }
                if (col === 'countries') {
                    let countries = getByPath(item, col);
                    if (countries == null) countries = [];
                    if (typeof countries === 'string') countries = countries.split(',');
                    if (!Array.isArray(countries)) {
                        try { countries = JSON.parse(String(countries)); } catch { countries = [String(countries)]; }
                    }
                    countries = countries.map(c => String(c).trim()).filter(Boolean);
                    const uniq = Array.from(new Set(countries));
                    const shown = uniq.slice(0, 4);
                    const more = uniq.length - shown.length;
                    const pills = shown.map(c => `<span class=\"badge country-pill\">${escapeHTML(c)}</span>`).join(' ');
                    const moreBadge = more > 0 ? ` <span class=\"badge badge-neutral\">+${more}</span>` : '';
                    const title = uniq.join(', ');
                    return `<td title="${escapeAttr(title)}">${pills || '<span class=\"pill\">-</span>'}${moreBadge}</td>`;
                }

                let rawVal = getByPath(item, col);
                if (rawVal == null) rawVal = '';

                const rawType = typeof rawVal;
                if (rawType === 'boolean' || rawVal === 'true' || rawVal === 'false' || rawVal === true || rawVal === false) {
                    const b = (rawVal === true || rawVal === 'true');
                    const label = b ? 'Yes' : 'No';
                    const cls = b ? 'badge-success' : 'badge-danger';
                    return `<td title="${label}"><span class="badge ${cls}">${label}</span></td>`;
                }

                let val = rawVal;
                if (Array.isArray(val)) {
                    if (val.every(v => typeof v !== 'object')) {
                        val = val.join('; ');
                    } else {
                        try { val = JSON.stringify(val); } catch { val = String(val); }
                    }
                } else if (typeof val === 'object' && val !== null) {
                    try { val = JSON.stringify(val); } catch { val = String(val); }
                }

                if (isDateLikeKey(col)) {
                    const norm = normalizeDateValue(col, val);
                    return `<td title="${escapeAttr(String(norm))}"><span class="badge badge-neutral date-pill">${escapeHTML(String(norm))}</span></td>`;
                }

                if (col === 'guid') {
                    const html = renderGUIDWithLink(val);
                    return `<td title="${escapeAttr(String(val || ''))}">${html}</td>`;
                }

                const display = sanitizeCellDisplay(String(val));
                return `<td title="${escapeAttr(String(val))}">${display}</td>`;
            }).join('');
            const checked = selectedRows.has(id) ? 'checked' : '';
            const rowSelectedClass = selectedRows.has(id) ? 'selected' : '';
            return `
        <tr class="${rowSelectedClass}" data-row-id="${id}">
          <td><input type="checkbox" class="row-select row-checkbox" data-id="${id}" ${checked}/></td>
          ${tds}
        </tr>
      `;
        }).join('');

        if (!data.length) {
            const colSpan = 1 + visibleColumns.size;
            el.mediaTbody.innerHTML = `<tr><td colspan="${colSpan}" style="text-align:center; padding:2rem; color:var(--text-muted);">No media items found matching the current filters.</td></tr>`;
        }

        el.mediaTbody.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.addEventListener('change', (e) => {
                const id = e.target.getAttribute('data-id');
                const idx = displayedData.findIndex(it => getRowId(it) === id);
                const shouldCheck = e.target.checked;

                if (e.shiftKey && lastSelectedIndex !== null && idx !== -1) {
                    const start = Math.min(lastSelectedIndex, idx);
                    const end = Math.max(lastSelectedIndex, idx);
                    for (let i = start; i <= end; i++) {
                        const rid = getRowId(displayedData[i]);
                        if (shouldCheck) selectedRows.add(rid); else selectedRows.delete(rid);
                        const rowCb = el.mediaTbody.querySelector(`.row-checkbox[data-id="${rid}"]`);
                        if (rowCb) rowCb.checked = shouldCheck;
                    }
                } else {
                    if (shouldCheck) selectedRows.add(id);
                    else selectedRows.delete(id);
                    lastSelectedIndex = idx;
                }
                updateSelectionUI();
            });
        });

        el.mediaTbody.querySelectorAll('tr').forEach((tr, rowIndex) => {
            tr.addEventListener('click', (ev) => {
                const target = ev.target;
                if (!target) return;
                if (target.closest('a') || target.closest('button') || target.classList.contains('row-checkbox')) return;

                const rowId = tr.getAttribute('data-row-id');
                const cb = tr.querySelector('.row-checkbox');
                if (!rowId || !cb) return;

                if (ev.metaKey || ev.ctrlKey) {
                    cb.checked = !cb.checked;
                    if (cb.checked) selectedRows.add(rowId); else selectedRows.delete(rowId);
                    lastSelectedIndex = rowIndex;
                } else if (ev.shiftKey && lastSelectedIndex !== null) {
                    const start = Math.min(lastSelectedIndex, rowIndex);
                    const end = Math.max(lastSelectedIndex, rowIndex);
                    const shouldCheck = true;
                    for (let i = start; i <= end; i++) {
                        const rid = getRowId(displayedData[i]);
                        selectedRows.add(rid);
                        const rowCb = el.mediaTbody.querySelector(`.row-checkbox[data-id="${rid}"]`);
                        if (rowCb) rowCb.checked = true;
                    }
                } else {
                    selectedRows.clear();
                    cb.checked = true;
                    selectedRows.add(rowId);
                    lastSelectedIndex = rowIndex;
                }

                updateSelectionUI();
            });
        });

        el.mediaTbody.querySelectorAll('td.clickable-cell').forEach(td => {
            td.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const tr = td.closest('tr');
                const rowId = tr && tr.getAttribute('data-row-id');
                const item = displayedData.find(it => getRowId(it) === rowId);
                if (item) openDetailsPanel(item);
            });
        });

        updateSelectionUI();
    }

    function updateSelectionUI() {
        const count = selectedRows.size;
        el.selectionCount.textContent = `${count} selected`;

        const idsOnPage = displayedData.map(getRowId);
        const selectedOnPage = idsOnPage.filter(id => selectedRows.has(id)).length;
        if (idsOnPage.length === 0) {
            el.selectAllCheckbox.checked = false;
            el.selectAllCheckbox.indeterminate = false;
        } else if (selectedOnPage === 0) {
            el.selectAllCheckbox.checked = false;
            el.selectAllCheckbox.indeterminate = false;
        } else if (selectedOnPage === idsOnPage.length) {
            el.selectAllCheckbox.checked = true;
            el.selectAllCheckbox.indeterminate = false;
        } else {
            el.selectAllCheckbox.checked = false;
            el.selectAllCheckbox.indeterminate = true;
        }

        el.mediaTbody.querySelectorAll('tr').forEach(tr => {
            const cb = tr.querySelector('.row-checkbox');
            if (!cb) return;
            const id = cb.getAttribute('data-id');
            const isSelected = selectedRows.has(id);
            cb.checked = isSelected;
            if (isSelected) tr.classList.add('selected');
            else tr.classList.remove('selected');
        });
    }

    function selectAllVisible() {
        displayedData.forEach(item => selectedRows.add(getRowId(item)));
        updateSelectionUI();
    }
    function deselectAllVisible() {
        displayedData.forEach(item => selectedRows.delete(getRowId(item)));
        updateSelectionUI();
    }
    function selectAllFiltered() {
        filteredData.forEach(item => selectedRows.add(getRowId(item)));
        updateSelectionUI();
    }
    function clearSelection() {
        selectedRows.clear();
        updateSelectionUI();
    }

    function exportToCsv() {
        el.exportCsvBtn.disabled = true;
        el.exportCsvBtn.textContent = '🔄 Loading...';
        try {
            let data = [];
            if (selectedRows.size > 0) {
                const ids = new Set(selectedRows);
                data = filteredData.filter(item => ids.has(getRowId(item)));
            } else {
                data = filteredData;
            }
            if (!data.length) {
                alert('No data to export');
                return;
            }
            const headers = Array.from(visibleColumns);
            const lines = [
                headers.map(h => escapeCSV(h)).join(','),
                ...data.map(item => headers.map(h => {
                    let v;
                    if (h === 'CMAF Status') {
                        v = getCMAFStatus(item);
                    } else {
                        v = getByPath(item, h);
                        if (h === 'cbs$premiumFeatures' || h === 'premium_features') {
                            v = normalizeAndSortFeatures(item.premium_features || []).join('; ');
                        }
                    }
                    if (v == null) v = '';
                    if (typeof v === 'object') {
                        try { v = JSON.stringify(v); } catch { v = String(v); }
                    }
                    if (Array.isArray(v)) {
                        if (v.every(x => typeof x !== 'object')) v = v.join('; ');
                        else { try { v = JSON.stringify(v); } catch { v = String(v); } }
                    }
                    if (isTimestampKey(h, v)) {
                        const n = Number(v);
                        if (!Number.isNaN(n) && n > 0) v = new Date(n).toISOString();
                    }
                    return escapeCSV(String(v));
                }).join(','))
            ];
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `media_export_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
        } finally {
            el.exportCsvBtn.disabled = false;
            el.exportCsvBtn.textContent = '📊 Export to CSV';
        }
    }

    // Multi-selects
    const filterConfigs = {
        series: { field: 'series_title', label: 'Series', icon: '📺' },
        contentType: { field: 'content_type', label: 'Content Type', icon: '🎭' },
        availability: { field: 'availability_state', label: 'Availability', icon: '📡' },
        features: { field: 'premium_features', label: 'Features', icon: '⭐', isArray: true },
        cmaf: { field: 'cmaf_status', label: 'CMAF', icon: '📦', isComputed: true },
        season: { field: 'season_number', label: 'Season', icon: '🔢' },
        episode: { field: 'episode_number', label: 'Episode', icon: '🎬' },
        columns: { field: '__columns__', label: 'Columns', icon: '🧱', isCustom: true }
    };

    function initializeMultiSelect() {
        const buttons = document.querySelectorAll('.multi-select-button');

        buttons.forEach(button => {
            const container = button.closest('.multi-select-container');
            const dropdown = container.querySelector('.multi-select-dropdown');
            const filterType = button.getAttribute('data-filter');

            button.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                    if (dd !== dropdown) dd.classList.remove('open');
                });
                document.querySelectorAll('.multi-select-button').forEach(b => {
                    if (b !== button) b.classList.remove('active');
                });

                dropdown.classList.toggle('open');
                button.classList.toggle('active');
                if (dropdown.classList.contains('open')) {
                    populateDropdown(filterType, dropdown);
                    const searchInput = dropdown.querySelector('.multi-select-search input');
                    if (searchInput) setTimeout(() => searchInput.focus(), 50);
                }
            });
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-container')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(dd => dd.classList.remove('open'));
                document.querySelectorAll('.multi-select-button').forEach(b => b.classList.remove('active'));
            }
        });

        el.clearAllFilters.addEventListener('click', () => {
            Object.keys(activeFilters).forEach(k => activeFilters[k].clear());
            updateActiveFiltersDisplay();
            applyFiltersAndPagination();
        });

        updateButtonText('columns');
        updateActiveFiltersDisplay();
    }

    function populateDropdown(filterType, dropdown) {
        const cfg = filterConfigs[filterType];
        dropdown.innerHTML = '';

        const searchContainer = document.createElement('div');
        searchContainer.className = 'multi-select-search';
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = `Search ${cfg.label.toLowerCase()}...`;
        searchContainer.appendChild(searchInput);
        dropdown.appendChild(searchContainer);

        const optionsContainer = document.createElement('div');
        optionsContainer.className = 'multi-select-options';
        dropdown.appendChild(optionsContainer);

        const noResults = document.createElement('div');
        noResults.className = 'no-results';
        noResults.textContent = 'No options found';
        noResults.style.display = 'none';
        dropdown.appendChild(noResults);

        let values = [];
        if (filterType === 'columns') {
            const blocked = new Set(['content','thumbnails']);
            values = [...ALL_COLUMNS].filter(c => !blocked.has(c)).sort((a,b)=>a.localeCompare(b));
        } else if (cfg.isComputed && filterType === 'cmaf') {
            values = ['Enabled','Disabled'];
        } else {
            const s = new Set();
            allData.forEach(item => {
                let v = item[cfg.field];
                if (filterType === 'features') v = normalizeAndSortFeatures(v || []);
                if (cfg.isArray && Array.isArray(v)) v.forEach(x => x && s.add(String(x)));
                else if (v !== null && v !== undefined && v !== '') s.add(String(v));
            });
            values = [...s].sort((a,b)=>{
                if (!isNaN(a) && !isNaN(b)) return Number(a)-Number(b);
                return a.localeCompare(b);
            });
        }

        values.forEach(val => {
            const opt = document.createElement('div');
            opt.className = 'multi-select-option';
            opt.setAttribute('data-value', String(val).toLowerCase());
            const cb = document.createElement('input');
            cb.type = 'checkbox';
            if (filterType === 'columns') cb.checked = visibleColumns.has(val);
            else cb.checked = activeFilters[filterType].has(val);

            cb.addEventListener('change', () => {
                if (filterType === 'columns') {
                    if (cb.checked) visibleColumns.add(val);
                    else visibleColumns.delete(val);
                    updateButtonText('columns');
                    renderTableHeader();
                    renderTableBody(displayedData);
                } else {
                    if (cb.checked) activeFilters[filterType].add(val);
                    else activeFilters[filterType].delete(val);
                    updateButtonText(filterType);
                    updateActiveFiltersDisplay();
                    currentPage = 1;
                    selectedRows.clear();
                    applyFiltersAndPagination();
                }
            });

            const label = document.createElement('span');
            label.textContent = val;

            opt.appendChild(cb);
            opt.appendChild(label);
            optionsContainer.appendChild(opt);
        });

        searchInput.addEventListener('input', () => {
            const q = searchInput.value.toLowerCase();
            let visible = 0;
            optionsContainer.querySelectorAll('.multi-select-option').forEach(opt => {
                const v = opt.getAttribute('data-value') || '';
                if (v.includes(q)) { opt.classList.remove('hidden'); visible++; }
                else opt.classList.add('hidden');
            });
            noResults.style.display = (visible === 0 && q) ? 'block' : 'none';
        });
    }

    function updateButtonText(filterType) {
        const button = document.querySelector(`.multi-select-button[data-filter="${filterType}"]`);
        if (!button) return;
        const span = button.querySelector('span');
        if (filterType === 'columns') {
            const count = visibleColumns.size;
            span.textContent = `${count} column${count !== 1 ? 's':''}selected`;
            return;
        }
        const cfg = filterConfigs[filterType];
        const count = activeFilters[filterType].size;
        span.textContent = count ? `${count} ${cfg.label.toLowerCase()}${count>1?'s':''} selected` : `Select ${cfg.label.toLowerCase()}...`;
    }

    function updateActiveFiltersDisplay() {
        el.activeFilters.innerHTML = '';
        let has = false;
        Object.keys(activeFilters).forEach(type => {
            const cfg = filterConfigs[type];
            activeFilters[type].forEach(val => {
                has = true;
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                const cat = document.createElement('span');
                cat.className = 'filter-chip-category';
                cat.textContent = `${cfg.icon} ${cfg.label}:`;
                const text = document.createElement('span');
                text.textContent = val;
                const rm = document.createElement('button');
                rm.className = 'remove-chip';
                rm.textContent = '×';
                rm.addEventListener('click', () => {
                    activeFilters[type].delete(val);
                    updateButtonText(type);
                    updateActiveFiltersDisplay();
                    currentPage = 1;
                    selectedRows.clear();
                    applyFiltersAndPagination();
                });
                chip.appendChild(cat); chip.appendChild(text); chip.appendChild(rm);
                el.activeFilters.appendChild(chip);
            });
        });
        if (!has) {
            const span = document.createElement('span');
            span.style.color = 'var(--text-muted)';
            span.style.fontStyle = 'italic';
            span.textContent = 'No filters applied';
            el.activeFilters.appendChild(span);
        }
    }

    function setupEvents() {
        let t;
        el.search.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(() => {
                currentPage = 1;
                applyFiltersAndPagination();
            }, 300);
        });

        el.perPage.addEventListener('change', () => {
            currentPage = 1;
            applyFiltersAndPagination();
        });

        el.prevBtn.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; applyFiltersAndPagination(); }
        });
        el.nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) { currentPage++; applyFiltersAndPagination(); }
        });

        el.selectAllCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) selectAllVisible();
            else deselectAllVisible();
        });

        el.selectAllVisibleBtn.addEventListener('click', selectAllVisible);
        el.selectAllBtn.addEventListener('click', selectAllFiltered);
        el.clearSelectionBtn.addEventListener('click', clearSelection);
        el.exportCsvBtn.addEventListener('click', exportToCsv);

        if (el.closeDetailsBtn) {
            el.closeDetailsBtn.addEventListener('click', () => {
                closeDetailsPanel();
            });
        }
    }

    function closeDetailsPanel() {
        if (el.detailsContent) {
            el.detailsContent.innerHTML = 'Select a media item to view details.';
        }
        const panel = document.getElementById('details-panel');
        if (panel) panel.classList.remove('open');
    }

    function openDetailsPanel(item) {
        const panel = el.detailsContent;
        const title = item.title || '(untitled)';
        const series = item.series_title ? ` • ${item.series_title}` : '';
        const guid = item.guid || item.external_id || '';
        const updatedSafe = normalizeDateValue('updated', item.updated_timestamp);
        const headerHTML = `
            <div class="kv" style="margin-bottom:.5rem;">
                <div class="key">Title</div><div>${escapeHTML(title)}${series}</div>
                <div class="key">GUID</div><div>${escapeHTML(guid)} ${guid ? `<a class="link" href="https://videorobot.cbsivideo.com/#/video/${encodeURIComponent(guid)}" target="_blank" rel="noopener">Open in VR ↗</a>` : ''}</div>
                <div class="key">Updated</div><div>${updatedSafe ? escapeHTML(String(updatedSafe)) : '-'}</div>
            </div>
        `;

        const feats = normalizeAndSortFeatures(item.premium_features || []);
        const featuresHTML = feats.length
            ? feats.map(f => `<span class="feature-pill">${escapeHTML(String(f))}</span>`).join('')
            : '<span class="pill">No features</span>';

        const toArray = (v) => Array.isArray(v) ? v : (v && typeof v === 'object' ? Object.values(v) : []);
        const contentArr = toArray(item.content);
        const thumbsArr = toArray(item.thumbnails);

        panel.innerHTML = `
            ${headerHTML}
            <div class="section-title">Premium Features</div>
            <div style="margin-bottom:.5rem;">${featuresHTML}</div>

            <div class="section-title">Content Renditions (${contentArr.length})</div>
            <div class="media-grid">
                ${contentArr.map((c, i) => `
                    <div style="border:1px solid var(--border-light); border-radius:8px; padding:.5rem; background:var(--surface-2);">
                        <div class="pill" style="margin-bottom:.5rem;">#${i+1} ${escapeHTML(c.title || c.format || c.contentType || '')}</div>
                        <div class="kv">
                            <div class="key">ID</div><div>${escapeHTML(c.id || '')}</div>
                            <div class="key">GUID</div><div>${escapeHTML(c.guid || '')}</div>
                            <div class="key">Format</div><div>${escapeHTML(c.format || '')}</div>
                            <div class="key">Type</div><div>${escapeHTML(c.contentType || '')}</div>
                            <div class="key">Bitrate</div><div>${escapeHTML(c.bitrate || '')}</div>
                            <div class="key">Asset Types</div><div>${Array.isArray(c.assetTypes)? c.assetTypes.map(a=>`<span class="pill">${escapeHTML(String(a))}</span>`).join(' ') : ''}</div>
                            <div class="key">URL</div><div>${c.url ? `<a class="link" href="${escapeAttr(c.url)}" target="_blank" rel="noopener">Open Source ↗</a>` : '-'}</div>
                            <div class="key">Streaming</div><div>${c.streamingUrl ? `<a class="link" href="${escapeAttr(c.streamingUrl)}" target="_blank" rel="noopener">Open Stream ↗</a>` : '-'}</div>
                            <div class="key">Added</div><div>${(() => { const v = normalizeDateValue('added', c.added); return v ? escapeHTML(String(v)) : '-'; })()}</div>
                            <div class="key">Updated</div><div>${(() => { const v = normalizeDateValue('updated', c.updated); return v ? escapeHTML(String(v)) : '-'; })()}</div>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="section-title">Thumbnails (${thumbsArr.length})</div>
            <div class="thumb-grid">
                ${thumbsArr.map((t, i) => `
                    <div class="thumb">
                        ${t.url ? `<img src="${escapeAttr(t.url)}" alt="thumbnail ${i+1}"/>` : ''}
                        <div style="padding:.5rem;">
                            <div class="pill" style="margin-bottom:.25rem;">#${i+1} ${escapeHTML(t.title || t.format || t.contentType || '')}</div>
                            <div class="kv">
                                <div class="key">ID</div><div>${escapeHTML(t.id || '')}</div>
                                <div class="key">GUID</div><div>${escapeHTML(t.guid || '')}</div>
                                <div class="key">Format</div><div>${escapeHTML(t.format || '')}</div>
                                <div class="key">Type</div><div>${escapeHTML(t.contentType || '')}</div>
                                <div class="key">Asset Types</div><div>${Array.isArray(t.assetTypes)? t.assetTypes.map(a=>`<span class="pill">${escapeHTML(String(a))}</span>`).join(' ') : ''}</div>
                                <div class="key">URL</div><div>${t.url ? `<a class="link" href="${escapeAttr(t.url)}" target="_blank" rel="noopener">Open Image ↗</a>` : '-'}</div>
                                <div class="key">Added</div><div>${(() => { const v = normalizeDateValue('added', t.added); return v ? escapeHTML(String(v)) : '-'; })()}</div>
                                <div class="key">Updated</div><div>${(() => { const v = normalizeDateValue('updated', t.updated); return v ? escapeHTML(String(v)) : '-'; })()}</div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;

        document.getElementById('details-panel').classList.add('open');
    }

    async function initialize() {
        await loadConfig();
        initializeMultiSelect();
        setupEvents();
        ['series','contentType','availability','features','cmaf','season','episode','columns'].forEach(updateButtonText);
        await loadFilters();
        await loadData();
        document.getElementById('details-panel').classList.remove('open');
    }

    initialize();
</script>
</body>
</html>
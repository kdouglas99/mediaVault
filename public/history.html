<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History Admin - Media Vault</title>
    <style>
        /* Design tokens matching App.css */
        :root {
            --bg: #0f172a;
            --surface: #111827;
            --surface-2: #0b1220;
            --text: #ffffff;
            --text-muted: rgba(255,255,255,0.75);
            --border: #1f2937;
            --primary: #60a5fa;
            --primary-hover: #3b82f6;
            --accent: #34d399;
            --accent-hover: #10b981;
            --danger: #f87171;
            --danger-hover: #ef4444;
            --warning: #fbbf24;
            --info: #0ea5e9;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
            --radius: 12px;
            --focus: 0 0 0 3px rgba(96,165,250,0.35);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,0.10), rgba(0,0,0,0) 40%),
            radial-gradient(900px 600px at 110% 10%, rgba(16,185,129,0.10), rgba(0,0,0,0) 35%),
            var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            min-height: 100vh;
            padding: 2rem 1.25rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            font-size: clamp(1.6rem, 2.4vw, 2.25rem);
            font-weight: 800;
            letter-spacing: 0.2px;
            color: var(--text);
            text-shadow: 0 1px 0 rgba(0,0,0,0.15);
            margin: 0;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
        }

        .nav-link {
            background: var(--surface);
            color: var(--text);
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .history-controls {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)), var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
        }

        .control-group input,
        .control-group select {
            padding: 0.75rem;
            border: 1px solid var(--border);
            background: var(--surface-2);
            color: var(--text);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            box-shadow: var(--focus);
            border-color: var(--primary);
            background: color-mix(in oklab, var(--surface-2), var(--primary) 6%);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: var(--danger-hover);
        }

        .btn-secondary {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .stats-bar {
            background: var(--surface-2);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            display: block;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .history-container {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)), var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .timeline {
            max-height: 70vh;
            overflow-y: auto;
            padding: 1rem;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 2rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 50px;
            bottom: -30px;
            width: 2px;
            background: var(--border);
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-marker {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 1rem;
            position: relative;
            z-index: 2;
        }

        .timeline-marker.create {
            background: var(--accent);
            color: white;
        }

        .timeline-marker.update {
            background: var(--primary);
            color: white;
        }

        .timeline-marker.delete {
            background: var(--danger);
            color: white;
        }

        .timeline-marker.toggle {
            background: var(--warning);
            color: white;
        }

        .timeline-marker.import {
            background: var(--info);
            color: white;
        }

        .timeline-content {
            flex: 1;
            background: var(--surface-2);
            border-radius: var(--radius);
            padding: 1.5rem;
            border: 1px solid var(--border);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .timeline-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .timeline-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.25rem;
        }

        .timeline-time {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .timeline-user {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .timeline-description {
            color: var(--text-muted);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .change-details {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .change-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .change-field {
            background: var(--surface);
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .field-name {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .field-change {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .field-old {
            color: var(--danger);
            font-family: monospace;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: color-mix(in oklab, var(--danger), transparent 90%);
            border-radius: 4px;
        }

        .field-new {
            color: var(--accent);
            font-family: monospace;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            background: color-mix(in oklab, var(--accent), transparent 90%);
            border-radius: 4px;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--surface-2);
            border-top: 1px solid var(--border);
        }

        .pagination-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pagination-controls button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            min-width: 100px;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .pagination-controls button:disabled {
            background: #6b7280;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .error {
            background: #7f1d1d;
            border: 1px solid var(--danger);
            color: var(--text);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state h3 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .pagination {
                flex-direction: column;
                gap: 1rem;
            }

            .pagination-controls {
                flex-direction: column;
                width: 100%;
            }

            .pagination-controls button {
                width: 100%;
            }

            .timeline-item {
                flex-direction: column;
                margin-left: 0;
            }

            .timeline-item::before {
                display: none;
            }

            .timeline-marker {
                margin-right: 0;
                margin-bottom: 1rem;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>📚 History Admin</h1>
        <div class="nav-links">
            <a href="dashboard.html" class="nav-link">📊 Dashboard</a>
            <a href="/" class="nav-link">🏠 Home</a>
        </div>
    </div>

    <div class="history-controls">
        <div class="controls-grid">
            <div class="control-group">
                <label for="search">🔍 Search Events</label>
                <input type="text" id="search" placeholder="Search by action, user, or target...">
            </div>

            <div class="control-group">
                <label for="type-filter">📋 Event Type</label>
                <select id="type-filter">
                    <option value="">All Events</option>
                    <option value="CREATE">Create</option>
                    <option value="UPDATE">Update</option>
                    <option value="DELETE">Delete</option>
                    <option value="IMPORT">Import</option>
                    <option value="EXPORT">Export</option>
                </select>
            </div>

            <div class="control-group">
                <label for="user-filter">👤 User</label>
                <select id="user-filter">
                    <option value="">All Users</option>
                </select>
            </div>

            <div class="control-group">
                <label for="date-from">📅 From Date</label>
                <input type="date" id="date-from">
            </div>

            <div class="control-group">
                <label for="date-to">📅 To Date</label>
                <input type="date" id="date-to">
            </div>

            <div class="control-group">
                <label for="items-per-page">📄 Items per Page</label>
                <select id="items-per-page">
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" id="refresh-history">🔄 Refresh</button>
            <button class="btn btn-secondary" id="clear-filters">🗑️ Clear Filters</button>
            <button class="btn btn-secondary" id="export-history">📊 Export History</button>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-number" id="total-events">0</span>
            <span class="stat-label">Total Events</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="filtered-events">0</span>
            <span class="stat-label">Filtered Results</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="unique-users">0</span>
            <span class="stat-label">Active Users</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="today-events">0</span>
            <span class="stat-label">Today's Events</span>
        </div>
    </div>

    <!-- History Container -->
    <div class="history-container">
        <div class="loading" id="loading">Loading history...</div>
        <div class="error" id="error" style="display: none;"></div>

        <div class="timeline" id="timeline" style="display: none;">
            <!-- Timeline items will be populated here -->
        </div>

        <div class="empty-state" id="empty-state" style="display: none;">
            <h3>📭 No History Found</h3>
            <p>No events found matching your current filters.</p>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
            <div class="pagination-info">
                <div id="pagination-main">Page 1 of 1</div>
                <div id="pagination-details">Showing 0 to 0 of 0 entries</div>
            </div>

            <div class="pagination-controls">
                <button id="prev-btn">« Previous</button>
                <button id="next-btn">Next »</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let API_BASE = '';
    let currentPage = 1;
    let totalPages = 1;
    let totalItems = 0;
    let itemsPerPage = 50;
    let isLoading = false;
    let historyData = [];
    let filteredData = [];

    // DOM Elements
    const elements = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        timeline: document.getElementById('timeline'),
        emptyState: document.getElementById('empty-state'),
        pagination: document.getElementById('pagination'),
        search: document.getElementById('search'),
        typeFilter: document.getElementById('type-filter'),
        userFilter: document.getElementById('user-filter'),
        dateFrom: document.getElementById('date-from'),
        dateTo: document.getElementById('date-to'),
        itemsPerPage: document.getElementById('items-per-page'),
        refreshBtn: document.getElementById('refresh-history'),
        clearFiltersBtn: document.getElementById('clear-filters'),
        exportBtn: document.getElementById('export-history'),
        totalEvents: document.getElementById('total-events'),
        filteredEvents: document.getElementById('filtered-events'),
        uniqueUsers: document.getElementById('unique-users'),
        todayEvents: document.getElementById('today-events'),
        paginationMain: document.getElementById('pagination-main'),
        paginationDetails: document.getElementById('pagination-details'),
        prevBtn: document.getElementById('prev-btn'),
        nextBtn: document.getElementById('next-btn')
    };

    // Load configuration from backend
    async function loadConfig() {
        try {
            // Try to get config from current origin first
            const response = await fetch('/api/config');
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    API_BASE = result.config.API_BASE;
                    console.log('Loaded API_BASE from config:', API_BASE);
                    return;
                }
            }
        } catch (error) {
            console.warn('Failed to load config from current origin, trying localhost:', error.message);
        }

        // Fallback to localhost for development
        try {
            const response = await fetch('http://localhost:3001/api/config');
            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    API_BASE = result.config.API_BASE;
                    console.log('Loaded API_BASE from localhost config:', API_BASE);
                    return;
                }
            }
        } catch (error) {
            console.warn('Failed to load config from localhost:', error.message);
        }

        // Final fallback
        API_BASE = 'http://localhost:3001/api';
        console.log('Using fallback API_BASE:', API_BASE);
    }

    // Load history data from API
    async function loadHistory() {
        if (isLoading) return;

        isLoading = true;
        showLoading(true);
        hideError();

        try {
            const params = buildQueryParams();
            const response = await fetch(`${API_BASE}/history?${params}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                historyData = result.data || [];
                totalItems = result.totalItems || 0;
                totalPages = result.totalPages || 1;
                currentPage = result.currentPage || 1;

                renderHistoryTimeline();
                updatePagination();
                updateStats();
                showContent();
            } else {
                throw new Error(result.error || 'Failed to load history');
            }
        } catch (error) {
            console.error('History loading error:', error);
            showError('Failed to load history: ' + error.message);
        }

        isLoading = false;
        showLoading(false);
    }

    // Build query parameters for API request
    function buildQueryParams() {
        const params = new URLSearchParams();

        params.append('page', currentPage.toString());
        params.append('limit', itemsPerPage.toString());

        if (elements.search.value.trim()) {
            params.append('search', elements.search.value.trim());
        }

        if (elements.typeFilter.value) {
            params.append('type', elements.typeFilter.value);
        }

        if (elements.userFilter.value) {
            params.append('user', elements.userFilter.value);
        }

        if (elements.dateFrom.value) {
            params.append('dateFrom', elements.dateFrom.value);
        }

        if (elements.dateTo.value) {
            params.append('dateTo', elements.dateTo.value);
        }

        return params;
    }

    // Show/hide loading state
    function showLoading(show) {
        elements.loading.style.display = show ? 'block' : 'none';
        elements.timeline.style.display = show ? 'none' : 'block';
        elements.pagination.style.display = show ? 'none' : 'flex';
        elements.emptyState.style.display = 'none';
    }

    // Show/hide error message
    function showError(message) {
        elements.error.textContent = message;
        elements.error.style.display = 'block';
        elements.timeline.style.display = 'none';
        elements.pagination.style.display = 'none';
        elements.emptyState.style.display = 'none';
    }

    function hideError() {
        elements.error.style.display = 'none';
    }

    // Show main content (timeline and pagination)
    function showContent() {
        elements.timeline.style.display = 'block';
        elements.pagination.style.display = 'flex';
        elements.error.style.display = 'none';

        if (historyData.length === 0) {
            elements.emptyState.style.display = 'block';
            elements.timeline.style.display = 'none';
            elements.pagination.style.display = 'none';
        } else {
            elements.emptyState.style.display = 'none';
        }
    }

    // Render the history timeline
    function renderHistoryTimeline() {
        if (!Array.isArray(historyData) || historyData.length === 0) {
            elements.timeline.innerHTML = '';
            return;
        }

        elements.timeline.innerHTML = historyData.map(item => {
            const eventType = (item.action || 'unknown').toLowerCase();
            const icon = getEventIcon(eventType);
            const timestamp = new Date(item.timestamp || Date.now());
            const timeStr = timestamp.toLocaleString();
            const user = item.user || 'System';

            let description = item.description || 'No description available';
            let changes = '';

            // If there are changes, render them
            if (item.changes && Object.keys(item.changes).length > 0) {
                changes = `
                    <div class="change-details">
                        <div class="change-grid">
                            ${Object.entries(item.changes).map(([field, change]) => `
                                <div class="change-field">
                                    <div class="field-name">${field}</div>
                                    <div class="field-change">
                                        ${change.old !== undefined ? `<div class="field-old">- ${formatValue(change.old)}</div>` : ''}
                                        ${change.new !== undefined ? `<div class="field-new">+ ${formatValue(change.new)}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="timeline-item">
                    <div class="timeline-marker ${eventType}">
                        ${icon}
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <h3 class="timeline-title">${item.title || item.action || 'Unknown Event'}</h3>
                            <div class="timeline-meta">
                                <div class="timeline-time">${timeStr}</div>
                                <div class="timeline-user">${user}</div>
                            </div>
                        </div>
                        <div class="timeline-description">${description}</div>
                        ${changes}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Get icon for event type
    function getEventIcon(eventType) {
        const icons = {
            create: '➕',
            update: '📝',
            delete: '🗑️',
            import: '📥',
            export: '📤',
            toggle: '🔄',
            unknown: '❓'
        };
        return icons[eventType] || icons.unknown;
    }

    // Format values for display
    function formatValue(value) {
        if (value === null || value === undefined) {
            return 'null';
        }
        if (typeof value === 'object') {
            return JSON.stringify(value, null, 2);
        }
        return String(value);
    }

    // Update pagination controls
    function updatePagination() {
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, totalItems);

        elements.paginationMain.textContent = `Page ${currentPage} of ${totalPages}`;
        elements.paginationDetails.textContent = `Showing ${startItem.toLocaleString()} to ${endItem.toLocaleString()} of ${totalItems.toLocaleString()} entries`;

        elements.prevBtn.disabled = currentPage <= 1;
        elements.nextBtn.disabled = currentPage >= totalPages;
    }

    // Update statistics
    function updateStats() {
        elements.totalEvents.textContent = totalItems.toLocaleString();
        elements.filteredEvents.textContent = historyData.length.toLocaleString();

        // Calculate unique users and today's events from current data
        const uniqueUsersSet = new Set(historyData.map(item => item.user).filter(Boolean));
        elements.uniqueUsers.textContent = uniqueUsersSet.size.toString();

        const today = new Date().toDateString();
        const todayEventsCount = historyData.filter(item => {
            const itemDate = new Date(item.timestamp || 0).toDateString();
            return itemDate === today;
        }).length;
        elements.todayEvents.textContent = todayEventsCount.toString();
    }

    // Clear all filters
    function clearFilters() {
        elements.search.value = '';
        elements.typeFilter.value = '';
        elements.userFilter.value = '';
        elements.dateFrom.value = '';
        elements.dateTo.value = '';
        currentPage = 1;
        loadHistory();
    }

    // Export history data
    async function exportHistory() {
        try {
            elements.exportBtn.disabled = true;
            elements.exportBtn.textContent = '🔄 Exporting...';

            // Get all data (not just current page)
            const params = buildQueryParams();
            params.delete('page');
            params.delete('limit');

            const response = await fetch(`${API_BASE}/history/export?${params}`);

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `history-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            console.error('Export error:', error);
            alert('Export failed: ' + error.message);
        } finally {
            elements.exportBtn.disabled = false;
            elements.exportBtn.textContent = '📊 Export History';
        }
    }

    // Event listeners
    function setupEventListeners() {
        // Search with debounce
        let searchTimeout;
        elements.search.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                loadHistory();
            }, 500);
        });

        // Filter changes
        [elements.typeFilter, elements.userFilter, elements.dateFrom, elements.dateTo].forEach(element => {
            element.addEventListener('change', () => {
                currentPage = 1;
                loadHistory();
            });
        });

        // Items per page
        elements.itemsPerPage.addEventListener('change', () => {
            itemsPerPage = parseInt(elements.itemsPerPage.value);
            currentPage = 1;
            loadHistory();
        });

        // Pagination
        elements.prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadHistory();
            }
        });

        elements.nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadHistory();
            }
        });

        // Action buttons
        elements.refreshBtn.addEventListener('click', () => loadHistory());
        elements.clearFiltersBtn.addEventListener('click', clearFilters);
        elements.exportBtn.addEventListener('click', exportHistory);
    }

    // Load users for filter dropdown
    async function loadUsers() {
        try {
            const response = await fetch(`${API_BASE}/users`);
            if (response.ok) {
                const result = await response.json();
                if (result.success && Array.isArray(result.data)) {
                    result.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id || user.name || user;
                        option.textContent = user.name || user.email || user;
                        elements.userFilter.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.warn('Failed to load users:', error);
        }
    }

    // Initialize the application
    async function initializeHistory() {
        try {
            // Load configuration first
            await loadConfig();

            // Set up event listeners
            setupEventListeners();

            // Load users for filter
            await loadUsers();

            // Load initial history data
            await loadHistory();
        } catch (error) {
            console.error('Failed to initialize history:', error);
            showError('Failed to initialize application: ' + error.message);
        }
    }

    // Start the application
    initializeHistory();
</script>
</body>
</html>